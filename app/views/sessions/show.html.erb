<% content_for :admin_tools do %>
  <p><%= link_to "Create New Session", new_topic_session_path( @session.topic ) %></p>
<% end %>

<%= error_messages_for 'session' %>

<div id="session-details">
  <h2>Session Details</h2>
  <dl>
    <dt>Time:</dt>
  	<% if @session.multiple_occurrences? %>
      <dd>This session meets <%= @session.occurrences.count %> times:</dd>
    <% end %>
    <% @session.occurrences.each do |o| %>
      <dd><%=h formatted_time_range(o.time, @session.topic.minutes) %></dd>
    <% end %>
  	<% if @session.registration_period_defined? %>
    	<dt>Registration Period:</dt>
    	<dd><%=h registration_period(@session) %></dd>
  	<% end %>
  	<dt>Location:</dt>
  	<dd><%=h @session.location %></dd>
  	<% if @session.instructors.size > 1 %>
  	  <dt>Instructors:</dt>
	  <% else %>
	    <dt>Instructor:</dt>
	  <% end %>
  	<dd>
  	  <ul class="instructor-list">
  	    <% @session.instructors.each do |instructor| %>
  	      <li><%= link_to instructor.name , 'mailto:' + instructor.email %></li>
  	    <% end %>
  	  </ul>
  	</dd>
  	<dt>Registration:</dt>
  	<dd>
  		<%=h @session.confirmed_reservations.size %>
  		<% if @session.seats %>
  			/ <%=h @session.seats %>
  		<% end %> 
  		registered
  		<% if @session.waiting_list.size > 0 %>
  			(<%=h @session.waiting_list.size %> waiting)
  		<% end %>
  		<% if @reservation %>
  		  <% if @reservation.attended? %>
  		    <p>You attended this session.</p>
  		  <% else %>
  		  	<% if @reservation.confirmed? %>
  		  		<p>You are registered for this session. </p>
  		  	<% else %>
  		  		<p>You are on the waiting list for this session.</p>
  		  	<% end %>
  		  	<div class="download-link download-calendar">
  		  		<%= link_to "[add reservation to calendar]", { :controller => :reservations, :action => :download, :id => @reservation.id } %>
  		  	</div>
  		  	<div class="register-button">
  		  		<%= link_to "Cancel Reservation", @reservation, :method => :delete, :confirm => "Are you sure you want to cancel your reservation for \"" + @reservation.session.topic.name + "\"?", :class => 'register-button' %>
  		  	</div>
  		  <% end %>	
  		<% elsif @session.in_registration_period? %>		
  			<% if @session.space_is_available? %>
          <div class="register-button">
  					<%= link_to "Register Now", new_session_reservation_path( @session ), :class => 'register-button' %>
          </div>

  			<% else %>
  				<div class="register-button">
  					<%= link_to "Add to Waiting List", new_session_reservation_path( @session ), :class => 'register-button' %>
  				</div>
  			<% end %>
			<% else %>
			  <p>Registration is closed for this session.</p>
  		<% end %>
    	<% if @session.topic.upcoming_sessions.size > 1 %>
    	  <dd><%= link_to 'Need to look for another session?', @session.topic %></dd>
      <% end %>
  	</dd>
  </dl>
</div>

<div id="topic-details">
  <h2>Topic Details</h2>
  <dl>
  	<dt>Topic:</dt>
  	<dd><%= link_to @session.topic.name, @session.topic%></dd>
    <dt>Description:</dt>
  	<dd><%= auto_link( simple_format( h( @session.topic.description ) ) ) %></dd>
  	<dt>Duration:</dt>
  	<dd><%=h @session.topic.minutes %> minutes</dd>
  	<dt>Department:</dt>
  	<dd><%=link_to @session.topic.department.name, @session.topic.department %></dd>
  	<% if !@session.topic.url.blank? %>
  		<dt>Additional Info:</dt>
  		<dd><%= link_to @session.topic.url, @session.topic.url %></dd>
  	<% end %>
  </dl>
</div>


<% if ( current_user && current_user.admin? ) or @session.instructor?( current_user ) %>
<div class="admin-options">
	<h2>Instructor/Admin Options</h2>
	<% if @session.confirmed_reservations.size > 0 %>
		<div class="admin-section">
			<h3>Reservations:</h3>
			<% form_for @session, :url => { :action => "update" } do |session_form| %>
				<%= hidden_field :reservations_update, :true %>
				<ul class="attendance-list" style="line-height: 1.5em">
				<% @session.confirmed_reservations.each do |reservation| %>
					<% session_form.fields_for :reservations, reservation do |reservation_fields|%>
						<li><span class="radio-span">
							<%= reservation_fields.radio_button :attended, Reservation::ATTENDANCE_UNKNOWN %>
							<%= reservation_fields.label :attended_0, '?' %>
							</span><span class="radio-span">
							<%= reservation_fields.radio_button :attended, Reservation::ATTENDANCE_ATTENDED %>
							<%= reservation_fields.label :attended_2, 'Attended' %>
							</span><span class="radio-span">
							<%= reservation_fields.radio_button :attended, Reservation::ATTENDANCE_MISSED %>
							<%= reservation_fields.label :attended_1, 'Missed' %>
							</span>
							<%= link_to reservation.user.name, 'mailto:' + reservation.user.email %>
							<%=h ', ' + reservation.user.department if !reservation.user.department.blank? %>
							<% if !reservation.special_accommodations.blank? %>
								: <span class="special-accommodations">(<%=h reservation.special_accommodations %>)</span>
							<% end %>
							<%= link_to '[cancel]', reservation, :method => :delete, :confirm => "Are you sure you want to cancel this reservation?" %>
						</li>
					<% end %>
				<% end%>
				</ul>
				<%= submit_tag "Record Attendance" %>
			<% end %>
			<%= link_to 'Print Attendance Sheet', {:action => :attendance, :id => @session, :format => "pdf" } %>
		</div>
	<% end %>

	<% if @session.waiting_list.size > 0 %>
		<div class="admin-section">
			<h3>Waiting List:</h3>
			<ul>
			<% @session.waiting_list.each do |reservation| %>
				<li><%=h reservation.user.name %> &lt;<%=h reservation.user.email %>&gt;</li>
			<% end%>
			</ul>
		</div>
	<% end %>
	
	<div class="admin-section">
		<h3>Update Details:</h3>
		<% form_for @session, :url => { :action => "update" } do |f| %>
			<%= render :partial => "form_fields", :locals => { :f => f }%>

			<br/><%= submit_tag "Make Changes" %>
		<% end %>
	</div>
	
	<% if @session.time > Time.now %>
		<div class="admin-section">
			<h3>Enroll Another Person:</h3>
			<%= form_tag :controller => :reservations, :action => :create, :session_id => @session.id %>
				<%= label_tag "user_login", "Login ID:", :class => 'field-label' %>
				<%= text_field_tag "user_login", nil, :size => 7 %><br/>
				<%= submit_tag "Enroll" %>
			</form>
		</div>
	<% end %>

	<% if @session.time > Time.now && !@session.cancelled %>
		<div class="admin-section">
			<h3>Cancel Session:</h3>
			<%= form_tag({}, { :method => :delete }) %>
				<%= label_tag "custom_message", "Reason for Cancellation (optional):", :class => 'field-label' %>
				<%= text_area_tag "custom_message", nil, :rows => 4, :cols => 60 %><br/>
				<%= submit_tag "Cancel Session", :confirm => "Are you sure you want to cancel this class? All registered attendees will be notified that the session has been cancelled." %>
			</form>
		</div>
	<% end %>
	
	<%= render :partial => "survey_responses/survey_summary", :locals => { :model_object => @session }%>

</div>
<% end %>